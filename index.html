<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Christmas - Final Clean</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        #ui-layer { position: absolute; bottom: 30px; width: 100%; text-align: center; pointer-events: none; z-index: 100; }
        .guide { color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 20px; text-shadow: 0 2px 4px black; }
        button { 
            pointer-events: auto; cursor: pointer; 
            background: linear-gradient(to bottom, #D32F2F, #8B0000); 
            color: #FFF; border: 2px solid #FFD700; padding: 15px 50px; 
            border-radius: 30px; font-weight: 800; font-size: 16px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        #camera-preview { position: absolute; top: 15px; right: 15px; width: 120px; height: 90px; border: 2px solid rgba(255,0,0,0.5); transform: scaleX(-1); opacity: 0.6; border-radius: 8px; }
        #copyright { position: absolute; bottom: 10px; right: 15px; color: rgba(255, 255, 255, 0.3); font-size: 12px; pointer-events: none; font-style: italic; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="ui-layer">
        <div class="guide">
            üñê <b>Open:</b> Explode | ‚ù§Ô∏è <b>Heart:</b> Love | ‚úä <b>Fist:</b> Tree
        </div>
        <button id="btnStart" onclick="startSystem()">START MAGIC</button>
    </div>
    <div id="copyright">¬© by vandiep</div>
    <video class="input_video" style="display:none;"></video>
    <canvas id="camera-preview"></canvas>

    <script>
        // --- C·∫§U H√åNH BI·∫æN TO√ÄN C·ª§C ---
        let scene, camera, renderer, bgMusic;
        let state = 'TREE';
        let handX = 0.5;
        let particlesGold, particlesRed, star;

        // √Çm thanh
        bgMusic = new Audio("./audio.mp3");
        bgMusic.loop = true;

        // --- KH·ªûI T·∫†O 3D ---
        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // T·∫°o c√°c h·∫°t cho c√¢y th√¥ng
            particlesGold = createParticles(0xFFD700, 2000);
            particlesRed = createParticles(0xFF0000, 1000);
            scene.add(particlesGold);
            scene.add(particlesRed);

            // Ng√¥i sao
            const starGeo = new THREE.OctahedronGeometry(0.4, 0);
            const starMat = new THREE.MeshBasicMaterial({ color: 0xFFFF00 });
            star = new THREE.Mesh(starGeo, starMat);
            star.position.y = 5;
            scene.add(star);

            camera.position.z = 10;
        }

        function createParticles(color, count) {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*10;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            return new THREE.Points(geo, new THREE.PointsMaterial({ color: color, size: 0.05 }));
        }

        // --- H√ÄM CH√çNH KHI NH·∫§N N√öT ---
        function startSystem() {
            document.getElementById('btnStart').style.display = 'none';
            bgMusic.play().catch(e => console.log("Thi·∫øu file audio.mp3"));

            init3D();

            const videoElement = document.getElementsByClassName('input_video')[0];
            const canvasElement = document.getElementById('camera-preview');
            const canvasCtx = canvasElement.getContext('2d');

            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5 });
            
            hands.onResults((results) => {
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    handX = lm[9].x; // ƒêi·ªÅu khi·ªÉn xoay c√¢y

                    // Ki·ªÉm tra n·∫Øm tay hay x√≤e tay
                    const d = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y);
                    state = (d < 0.2) ? 'TREE' : 'EXPLODE';

                    // Ki·ªÉm tra tr√°i tim (2 tay)
                    if (results.multiHandLandmarks.length === 2) {
                        const h1 = results.multiHandLandmarks[0];
                        const h2 = results.multiHandLandmarks[1];
                        if(Math.hypot(h1[8].x - h2[8].x, h1[8].y - h2[8].y) < 0.1) state = 'HEART';
                    }
                }
            });

            const cam = new Camera(videoElement, {
                onFrame: async () => { await hands.send({ image: videoElement }); },
                width: 320, height: 240
            });
            cam.start();
            animate();
        }

        // --- V√íNG L·∫∂P HI·ªÇN TH·ªä ---
        function animate() {
            requestAnimationFrame(animate);
            scene.rotation.y += ( (handX - 0.5) * 0.2 - scene.rotation.y ) * 0.1;
            
            if(state === 'EXPLODE') {
                particlesGold.scale.set(1.2, 1.2, 1.2);
            } else if (state === 'HEART') {
                star.rotation.z += 0.2;
            } else {
                particlesGold.scale.set(1, 1, 1);
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            if(camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
