<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Christmas - Final Clean</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* CSS Giao di·ªán */
        body { margin: 0; overflow: hidden; background-color: #000000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        
        #ui-layer {
            position: absolute; bottom: 30px; width: 100%;
            text-align: center; pointer-events: none; z-index: 100;
        }

        .guide {
            color: rgba(255, 255, 255, 0.6); font-size: 13px;
            margin-bottom: 20px; text-shadow: 0 2px 4px black;
        }

        button {
            pointer-events: auto; cursor: pointer;
            background: linear-gradient(to bottom, #D32F2F, #8B0000);
            color: #FFF; border: 2px solid #FFD700; padding: 15px 50px;
            border-radius: 30px; font-weight: 800; font-size: 16px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #camera-preview {
            position: absolute; top: 15px; right: 15px;
            width: 120px; height: 90px;
            border: 2px solid rgba(255, 0, 0, 0.5);
            transform: scaleX(-1); opacity: 0.6; border-radius: 8px;
        }

        #copyright {
            position: absolute; bottom: 10px; right: 15px;
            color: rgba(255, 255, 255, 0.3); font-size: 12px;
            z-index: 100; font-family: sans-serif; pointer-events: none; font-style: italic;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="copyright">¬© by vandiep</div>

    <div id="ui-layer">
        <div class="guide">
            üñê <b>Open:</b> Explode | ‚ù§Ô∏è <b>Heart:</b> Love | ‚úä <b>Fist:</b> Tree
        </div>
        <button id="btnStart" onclick="startSystem()">START MAGIC</button>
    </div>

    <video class="input_video" style="display:none;"></video>
    <canvas id="camera-preview"></canvas>

    <script>
        // 1. C·∫§U H√åNH T√ÄI NGUY√äN
        const MUSIC_URL = "./audio.mp3";
        let bgMusic = new Audio(MUSIC_URL);
        bgMusic.loop = true;
        bgMusic.volume = 1.0;

        const loader = new THREE.TextureLoader();
        const photoFiles = ['./image1.jpeg', './image2.jpeg', './image3.jpeg', './image4.jpeg', './image5.jpeg'];
        const photoTextures = [];
        photoFiles.forEach((f, i) => photoTextures[i] = loader.load(f));

        // Bi·∫øn m√¥i tr∆∞·ªùng
        let state = 'TREE';
        let handX = 0.5;
        let selectedIndex = 0;
        let scene, camera, renderer;
        let groupGold, groupRed, groupGift, starMesh, loveMesh;
        let photoMeshes = [];

        const CONFIG = { photoOrbitRadius: 4 };

        // 2. KH·ªûI T·∫†O 3D (R√∫t g·ªçn theo logic c·ªßa b·∫°n)
        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // T·∫°o hi·ªáu ·ª©ng h·∫°t c√¢y th√¥ng
            groupGold = createParticleGroup(0xFFD700, 1500);
            groupRed = createParticleGroup(0xFF0000, 1000);
            groupGift = createParticleGroup(0x00FF00, 200);
            scene.add(groupGold, groupRed, groupGift);

            // Ng√¥i sao v√† Tr√°i tim
            starMesh = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), new THREE.MeshBasicMaterial({color: 0xFFFF00}));
            starMesh.position.y = 5;
            scene.add(starMesh);

            loveMesh = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), new THREE.MeshBasicMaterial({color: 0xFF0000, transparent: true, opacity: 0.8}));
            loveMesh.visible = false;
            scene.add(loveMesh);

            // ·∫¢nh qu√† t·∫∑ng
            for(let i=0; i<5; i++) {
                let m = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), new THREE.MeshBasicMaterial({map: photoTextures[i]}));
                m.visible = false;
                photoMeshes.push(m);
                scene.add(m);
            }

            camera.position.z = 10;
        }

        function createParticleGroup(color, count) {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*10;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            return new THREE.Points(geo, new THREE.PointsMaterial({color: color, size: 0.05}));
        }

        // 3. V√íNG L·∫∂P ANIMATION
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            const handRotY = (handX - 0.5) * 4.0;
            scene.rotation.y += (handRotY - scene.rotation.y) * 0.1;

            if (state === 'TREE') {
                starMesh.visible = true; loveMesh.visible = false;
                starMesh.rotation.z -= 0.02;
                photoMeshes.forEach(m => m.visible = false);
            } else if (state === 'HEART') {
                starMesh.visible = false; loveMesh.visible = true;
                loveMesh.scale.set(1 + Math.sin(time*3)*0.1, 1 + Math.sin(time*3)*0.1, 1);
                photoMeshes.forEach(m => m.visible = false);
            } else if (state === 'EXPLODE') {
                starMesh.visible = false; loveMesh.visible = false;
                photoMeshes.forEach((m, i) => {
                    m.visible = true;
                    let angle = (time + i * (Math.PI * 2 / 5));
                    m.position.set(Math.sin(angle)*CONFIG.photoOrbitRadius, Math.sin(time+i)*0.5, Math.cos(angle)*CONFIG.photoOrbitRadius);
                    m.lookAt(camera.position);
                });
            }
            renderer.render(scene, camera);
        }

        // 4. H√ÄM CH√çNH
        function startSystem() {
            document.getElementById('btnStart').style.display = 'none';
            bgMusic.play().catch(e => console.error("Audio error"));
            
            init3D();

            const video = document.getElementsByClassName('input_video')[0];
            const canvas = document.getElementById('camera-preview');
            const ctx = canvas.getContext('2d');

            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

            hands.onResults((results) => {
                ctx.clearRect(0,0,120,90);
                ctx.drawImage(results.image, 0, 0, 120, 90);

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    handX = lm[9].x;
                    
                    // Nh·∫≠n di·ªán c·ª≠ ch·ªâ
                    const openDist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y);
                    if (openDist < 0.2) state = 'TREE';
                    else state = 'EXPLODE';

                    if (results.multiHandLandmarks.length === 2) {
                        const h1 = results.multiHandLandmarks[0];
                        const h2 = results.multiHandLandmarks[1];
                        if (Math.hypot(h1[8].x - h2[8].x, h1[8].y - h2[8].y) < 0.1) state = 'HEART';
                    }
                } else {
                    state = 'TREE';
                }
            });

            // S·ª¨A L·ªñI: ƒê∆∞a Camera v√†o trong h√†m click
            const cameraUtils = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240
            });
            cameraUtils.start();
            animate();
        }

        window.addEventListener('resize', () => {
            if(camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
